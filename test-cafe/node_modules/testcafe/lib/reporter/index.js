"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const is_stream_1 = require("is-stream");
const plugin_host_1 = __importDefault(require("./plugin-host"));
const plugin_methods_1 = __importDefault(require("./plugin-methods"));
const format_command_1 = __importDefault(require("./command/format-command"));
const get_browser_1 = __importDefault(require("../utils/get-browser"));
const runtime_1 = require("../errors/runtime");
class Reporter {
    constructor(plugin, task, outStream, name) {
        this.plugin = new plugin_host_1.default(plugin, outStream, name);
        this.task = task;
        this.disposed = false;
        this.passed = 0;
        this.failed = 0;
        this.skipped = 0;
        this.testCount = task.tests.filter(test => !test.skip).length;
        this.reportQueue = Reporter._createReportQueue(task);
        this.stopOnFirstFail = task.opts.stopOnFirstFail;
        this.outStream = outStream;
        this.pendingTaskDonePromise = Reporter._createPendingPromise();
        this._assignTaskEventHandlers();
    }
    static _isSpecialStream(stream) {
        return stream.isTTY || stream === process.stdout || stream === process.stderr;
    }
    static _createPendingPromise() {
        let resolver = null;
        const promise = new Promise(resolve => {
            resolver = resolve;
        });
        promise.resolve = resolver;
        return promise;
    }
    static _createReportItem(test, runsPerTest) {
        return {
            fixture: test.fixture,
            test: test,
            testRunIds: [],
            screenshotPath: null,
            screenshots: [],
            videos: [],
            quarantine: null,
            errs: [],
            warnings: [],
            unstable: false,
            startTime: null,
            testRunInfo: null,
            pendingRuns: runsPerTest,
            pendingStarts: runsPerTest,
            pendingTestRunDonePromise: Reporter._createPendingPromise(),
            pendingTestRunStartPromise: Reporter._createPendingPromise(),
            browsers: []
        };
    }
    static _createReportQueue(task) {
        const runsPerTest = task.browserConnectionGroups.length;
        return task.tests.map(test => Reporter._createReportItem(test, runsPerTest));
    }
    static _createTestRunInfo(reportItem) {
        return {
            errs: lodash_1.sortBy(reportItem.errs, ['userAgent', 'code']),
            warnings: reportItem.warnings,
            durationMs: +new Date() - reportItem.startTime,
            unstable: reportItem.unstable,
            screenshotPath: reportItem.screenshotPath,
            screenshots: reportItem.screenshots,
            videos: reportItem.videos,
            quarantine: reportItem.quarantine,
            skipped: reportItem.test.skip,
            browsers: reportItem.browsers,
            testId: reportItem.test.id
        };
    }
    _getReportItemForTestRun(testRun) {
        return lodash_1.find(this.reportQueue, i => i.test === testRun.test);
    }
    async _shiftReportQueue() {
        let currentFixture = null;
        let nextReportItem = null;
        let reportItem = null;
        while (this.reportQueue.length && this.reportQueue[0].testRunInfo) {
            reportItem = this.reportQueue.shift();
            currentFixture = reportItem.fixture;
            // NOTE: here we assume that tests are sorted by fixture.
            // Therefore, if the next report item has a different
            // fixture, we can report this fixture start.
            nextReportItem = this.reportQueue[0];
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestDone,
                args: [
                    reportItem.test.name,
                    reportItem.testRunInfo,
                    reportItem.test.meta
                ]
            });
            if (!nextReportItem)
                continue;
            if (nextReportItem.fixture === currentFixture)
                continue;
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportFixtureStart,
                args: [
                    nextReportItem.fixture.name,
                    nextReportItem.fixture.path,
                    nextReportItem.fixture.meta
                ]
            });
        }
    }
    async _resolveReportItem(reportItem, testRun) {
        if (this.task.screenshots.hasCapturedFor(testRun.test)) {
            reportItem.screenshotPath = this.task.screenshots.getPathFor(testRun.test);
            reportItem.screenshots = this.task.screenshots.getScreenshotsInfo(testRun.test);
        }
        if (this.task.videos)
            reportItem.videos = this.task.videos.getTestVideos(reportItem.test.id);
        if (testRun.quarantine) {
            reportItem.quarantine = testRun.quarantine.attempts.reduce((result, errors, index) => {
                const passed = !errors.length;
                const quarantineAttempt = index + 1;
                result[quarantineAttempt] = { passed };
                return result;
            }, {});
        }
        if (!reportItem.testRunInfo) {
            reportItem.testRunInfo = Reporter._createTestRunInfo(reportItem);
            if (reportItem.test.skip)
                this.skipped++;
            else if (reportItem.errs.length)
                this.failed++;
            else
                this.passed++;
        }
        await this._shiftReportQueue();
        reportItem.pendingTestRunDonePromise.resolve();
    }
    _prepareReportTestActionEventArgs({ command, duration, result, testRun, err }) {
        const args = {};
        if (err)
            args.err = err;
        if (typeof duration === 'number')
            args.duration = duration;
        return Object.assign(args, {
            testRunId: testRun.id,
            test: {
                id: testRun.test.id,
                name: testRun.test.name,
                phase: testRun.phase,
            },
            fixture: {
                name: testRun.test.fixture.name,
                id: testRun.test.fixture.id
            },
            command: format_command_1.default(command, result),
            browser: testRun.controller.browser,
        });
    }
    async dispatchToPlugin({ method, args = [] }) {
        try {
            // @ts-ignore
            await this.plugin[method](...args);
        }
        catch (originalError) {
            const uncaughtError = new runtime_1.ReporterPluginError({
                name: this.plugin.name,
                method,
                originalError
            });
            this.task.emit('error', uncaughtError);
        }
    }
    async _onceTaskStartHandler() {
        const startTime = new Date();
        const userAgents = this.task.browserConnectionGroups.map(group => group[0].userAgent);
        const first = this.reportQueue[0];
        const taskProperties = {
            configuration: this.task.opts
        };
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportTaskStart,
            args: [
                startTime,
                userAgents,
                this.testCount,
                this.task.testStructure,
                taskProperties
            ]
        });
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportFixtureStart,
            args: [
                first.fixture.name,
                first.fixture.path,
                first.fixture.meta
            ]
        });
    }
    async _onTaskTestRunStartHandler(testRun) {
        const reportItem = this._getReportItemForTestRun(testRun);
        reportItem.testRunIds.push(testRun.id);
        if (!reportItem.startTime)
            reportItem.startTime = +new Date();
        reportItem.pendingStarts--;
        if (!reportItem.pendingStarts) {
            // @ts-ignore
            if (this.plugin.reportTestStart) {
                const testStartInfo = { testRunIds: reportItem.testRunIds, testId: reportItem.test.id };
                await this.dispatchToPlugin({
                    method: plugin_methods_1.default.reportTestStart,
                    args: [
                        reportItem.test.name,
                        reportItem.test.meta,
                        testStartInfo
                    ]
                });
            }
            reportItem.pendingTestRunStartPromise.resolve();
        }
        return reportItem.pendingTestRunStartPromise;
    }
    async _onTaskTestRunDoneHandler(testRun) {
        const reportItem = this._getReportItemForTestRun(testRun);
        const isTestRunStoppedTaskExecution = !!testRun.errs.length && this.stopOnFirstFail;
        reportItem.pendingRuns = isTestRunStoppedTaskExecution ? 0 : reportItem.pendingRuns - 1;
        reportItem.unstable = reportItem.unstable || testRun.unstable;
        reportItem.errs = reportItem.errs.concat(testRun.errs);
        reportItem.warnings = testRun.warningLog ? lodash_1.union(reportItem.warnings, testRun.warningLog.messages) : [];
        reportItem.browsers.push(Object.assign({ testRunId: testRun.id }, get_browser_1.default(testRun.browserConnection)));
        if (!reportItem.pendingRuns)
            await this._resolveReportItem(reportItem, testRun);
        await reportItem.pendingTestRunDonePromise;
    }
    async _onTaskTestActionStart(_a) {
        var { apiActionName } = _a, restArgs = __rest(_a, ["apiActionName"]);
        // @ts-ignore
        if (this.plugin.reportTestActionStart) {
            restArgs = this._prepareReportTestActionEventArgs(restArgs);
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestActionStart,
                args: [
                    apiActionName,
                    restArgs
                ]
            });
        }
    }
    async _onTaskTestActionDone(_a) {
        var { apiActionName } = _a, restArgs = __rest(_a, ["apiActionName"]);
        // @ts-ignore
        if (this.plugin.reportTestActionDone) {
            restArgs = this._prepareReportTestActionEventArgs(restArgs);
            await this.dispatchToPlugin({
                method: plugin_methods_1.default.reportTestActionDone,
                args: [
                    apiActionName,
                    restArgs
                ]
            });
        }
    }
    async _onceTaskDoneHandler() {
        const endTime = new Date();
        const result = {
            passedCount: this.passed,
            failedCount: this.failed,
            skippedCount: this.skipped
        };
        await this.dispatchToPlugin({
            method: plugin_methods_1.default.reportTaskDone,
            args: [
                endTime,
                this.passed,
                this.task.warningLog.messages,
                result
            ]
        });
        this.pendingTaskDonePromise.resolve();
    }
    _assignTaskEventHandlers() {
        const task = this.task;
        task.once('start', async () => await this._onceTaskStartHandler());
        task.on('test-run-start', async (testRun) => await this._onTaskTestRunStartHandler(testRun));
        task.on('test-run-done', async (testRun) => await this._onTaskTestRunDoneHandler(testRun));
        task.on('test-action-start', async (e) => await this._onTaskTestActionStart(e));
        task.on('test-action-done', async (e) => await this._onTaskTestActionDone(e));
        task.once('done', async () => await this._onceTaskDoneHandler());
    }
    async dispose() {
        if (this.disposed)
            return Promise.resolve();
        this.disposed = true;
        if (!this.outStream || Reporter._isSpecialStream(this.outStream) || !is_stream_1.writable(this.outStream))
            return Promise.resolve();
        const streamFinishedPromise = new Promise(resolve => {
            this.outStream.once('finish', resolve);
            this.outStream.once('error', resolve);
        });
        this.outStream.end();
        return streamFinishedPromise;
    }
}
exports.default = Reporter;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVwb3J0ZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1DQUlnQjtBQUVoQix5Q0FBeUQ7QUFDekQsZ0VBQStDO0FBQy9DLHNFQUFvRDtBQUNwRCw4RUFBcUQ7QUFDckQsdUVBQThDO0FBQzlDLCtDQUF3RDtBQW1FeEQsTUFBcUIsUUFBUTtJQWF6QixZQUFvQixNQUEwQixFQUFFLElBQVUsRUFBRSxTQUFtQixFQUFFLElBQVk7UUFDekYsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHFCQUFrQixDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLElBQUksR0FBSyxJQUFJLENBQUM7UUFFbkIsSUFBSSxDQUFDLFFBQVEsR0FBaUIsS0FBSyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQW1CLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsTUFBTSxHQUFtQixDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBa0IsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxTQUFTLEdBQWdCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQzNFLElBQUksQ0FBQyxXQUFXLEdBQWMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxlQUFlLEdBQVUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUEwQixDQUFDO1FBQ25FLElBQUksQ0FBQyxTQUFTLEdBQWdCLFNBQVMsQ0FBQztRQUN4QyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsUUFBUSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFL0QsSUFBSSxDQUFDLHdCQUF3QixF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QyxTQUFTLElBQUksUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLG9CQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDakcsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFN0IsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNoRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVyQixPQUFPLHFCQUFxQixDQUFDO0lBQ2pDLENBQUM7Q0FDSjtBQXZYRCwyQkF1WEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIGZpbmQsXG4gICAgc29ydEJ5LFxuICAgIHVuaW9uXG59IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IHdyaXRhYmxlIGFzIGlzV3JpdGFibGVTdHJlYW0gfSBmcm9tICdpcy1zdHJlYW0nO1xuaW1wb3J0IFJlcG9ydGVyUGx1Z2luSG9zdCBmcm9tICcuL3BsdWdpbi1ob3N0JztcbmltcG9ydCBSZXBvcnRlclBsdWdpbk1ldGhvZCBmcm9tICcuL3BsdWdpbi1tZXRob2RzJztcbmltcG9ydCBmb3JtYXRDb21tYW5kIGZyb20gJy4vY29tbWFuZC9mb3JtYXQtY29tbWFuZCc7XG5pbXBvcnQgZ2V0QnJvd3NlciBmcm9tICcuLi91dGlscy9nZXQtYnJvd3Nlcic7XG5pbXBvcnQgeyBSZXBvcnRlclBsdWdpbkVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IFRhc2sgZnJvbSAnLi4vcnVubmVyL3Rhc2snO1xuaW1wb3J0IHsgV3JpdGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgV3JpdGVTdHJlYW0gfSBmcm9tICd0dHknO1xuaW1wb3J0IFRlc3RSdW4gZnJvbSAnLi4vdGVzdC1ydW4nO1xuaW1wb3J0IFRlc3QgZnJvbSAnLi4vYXBpL3N0cnVjdHVyZS90ZXN0JztcbmltcG9ydCBGaXh0dXJlIGZyb20gJy4uL2FwaS9zdHJ1Y3R1cmUvZml4dHVyZSc7XG5pbXBvcnQgVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyIGZyb20gJy4uL2Vycm9ycy90ZXN0LXJ1bi9mb3JtYXR0YWJsZS1hZGFwdGVyJztcbmltcG9ydCB7IENvbW1hbmQgfSBmcm9tICcuL2NvbW1hbmQvaW50ZXJmYWNlcyc7XG5cbmludGVyZmFjZSBQZW5kaW5nUHJvbWlzZSB7XG4gICAgcmVzb2x2ZTogRnVuY3Rpb24gfCBudWxsO1xuICAgIHRoZW46IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgUmVwb3J0SXRlbSB7XG4gICAgZml4dHVyZTogRml4dHVyZTtcbiAgICB0ZXN0OiBUZXN0O1xuICAgIHRlc3RSdW5JZHM6IHN0cmluZ1tdO1xuICAgIHNjcmVlbnNob3RQYXRoOiBudWxsIHwgc3RyaW5nO1xuICAgIHNjcmVlbnNob3RzOiB1bmtub3duW107XG4gICAgdmlkZW9zOiB1bmtub3duW107XG4gICAgcXVhcmFudGluZTogbnVsbDtcbiAgICBlcnJzOiBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXJbXTtcbiAgICB3YXJuaW5nczogc3RyaW5nW107XG4gICAgdW5zdGFibGU6IGJvb2xlYW47XG4gICAgc3RhcnRUaW1lOiBudWxsIHwgbnVtYmVyO1xuICAgIHRlc3RSdW5JbmZvOiBudWxsIHwgVGVzdFJ1bkluZm87XG4gICAgcGVuZGluZ1J1bnM6IG51bWJlcjtcbiAgICBwZW5kaW5nU3RhcnRzOiBudW1iZXI7XG4gICAgcGVuZGluZ1Rlc3RSdW5Eb25lUHJvbWlzZTogUGVuZGluZ1Byb21pc2U7XG4gICAgcGVuZGluZ1Rlc3RSdW5TdGFydFByb21pc2U6IFBlbmRpbmdQcm9taXNlO1xuICAgIGJyb3dzZXJzOiB1bmtub3duW107XG59XG5cbmludGVyZmFjZSBUZXN0UnVuSW5mbyB7XG4gICAgZXJyczogVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyW107XG4gICAgd2FybmluZ3M6IHN0cmluZ1tdO1xuICAgIGR1cmF0aW9uTXM6IG51bWJlcjtcbiAgICB1bnN0YWJsZTogYm9vbGVhbjtcbiAgICBzY3JlZW5zaG90UGF0aDogc3RyaW5nO1xuICAgIHNjcmVlbnNob3RzOiB1bmtub3duO1xuICAgIHZpZGVvczogdW5rbm93bjtcbiAgICBxdWFyYW50aW5lOiB1bmtub3duO1xuICAgIHNraXBwZWQ6IGJvb2xlYW47XG4gICAgYnJvd3NlcnM6IHVua25vd25bXTtcbiAgICB0ZXN0SWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFBsdWdpbk1ldGhvZEFyZ3VtZW50cyB7XG4gICAgbWV0aG9kOiBzdHJpbmc7XG4gICAgYXJnczogdW5rbm93bltdO1xufVxuXG5pbnRlcmZhY2UgUmVwb3J0VGVzdEFjdGlvbkV2ZW50QXJndW1lbnRzIHtcbiAgICBjb21tYW5kOiBDb21tYW5kO1xuICAgIGR1cmF0aW9uOiBudW1iZXI7XG4gICAgcmVzdWx0OiB1bmtub3duO1xuICAgIHRlc3RSdW46IFRlc3RSdW47XG4gICAgZXJyOiBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXI7XG59XG5cbmludGVyZmFjZSBSZXBvcnRUYXNrQWN0aW9uRXZlbnRBcmd1bWVudHMge1xuICAgIGFwaUFjdGlvbk5hbWU6IHN0cmluZztcbiAgICByZXN0QXJnczogb2JqZWN0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXBvcnRlciB7XG4gICAgcHVibGljIHJlYWRvbmx5IHBsdWdpbjogUmVwb3J0ZXJQbHVnaW5Ib3N0O1xuICAgIHB1YmxpYyByZWFkb25seSB0YXNrOiBUYXNrO1xuICAgIHB1YmxpYyBkaXNwb3NlZDogYm9vbGVhbjtcbiAgICBwdWJsaWMgcGFzc2VkOiBudW1iZXI7XG4gICAgcHVibGljIGZhaWxlZDogbnVtYmVyO1xuICAgIHB1YmxpYyBza2lwcGVkOiBudW1iZXI7XG4gICAgcHVibGljIHRlc3RDb3VudDogbnVtYmVyO1xuICAgIHB1YmxpYyByZWFkb25seSByZXBvcnRRdWV1ZTogUmVwb3J0SXRlbVtdO1xuICAgIHB1YmxpYyByZWFkb25seSBzdG9wT25GaXJzdEZhaWw6IGJvb2xlYW47XG4gICAgcHVibGljIHJlYWRvbmx5IG91dFN0cmVhbTogV3JpdGFibGU7XG4gICAgcHVibGljIHJlYWRvbmx5IHBlbmRpbmdUYXNrRG9uZVByb21pc2U6IFBlbmRpbmdQcm9taXNlO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChwbHVnaW46IFJlcG9ydGVyUGx1Z2luSG9zdCwgdGFzazogVGFzaywgb3V0U3RyZWFtOiBXcml0YWJsZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucGx1Z2luID0gbmV3IFJlcG9ydGVyUGx1Z2luSG9zdChwbHVnaW4sIG91dFN0cmVhbSwgbmFtZSk7XG4gICAgICAgIHRoaXMudGFzayAgID0gdGFzaztcblxuICAgICAgICB0aGlzLmRpc3Bvc2VkICAgICAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5wYXNzZWQgICAgICAgICAgICAgICAgID0gMDtcbiAgICAgICAgdGhpcy5mYWlsZWQgICAgICAgICAgICAgICAgID0gMDtcbiAgICAgICAgdGhpcy5za2lwcGVkICAgICAgICAgICAgICAgID0gMDtcbiAgICAgICAgdGhpcy50ZXN0Q291bnQgICAgICAgICAgICAgID0gdGFzay50ZXN0cy5maWx0ZXIodGVzdCA9PiAhdGVzdC5za2lwKS5sZW5ndGg7XG4gICAgICAgIHRoaXMucmVwb3J0UXVldWUgICAgICAgICAgICA9IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRRdWV1ZSh0YXNrKTtcbiAgICAgICAgdGhpcy5zdG9wT25GaXJzdEZhaWwgICAgICAgID0gdGFzay5vcHRzLnN0b3BPbkZpcnN0RmFpbCBhcyBib29sZWFuO1xuICAgICAgICB0aGlzLm91dFN0cmVhbSAgICAgICAgICAgICAgPSBvdXRTdHJlYW07XG4gICAgICAgIHRoaXMucGVuZGluZ1Rhc2tEb25lUHJvbWlzZSA9IFJlcG9ydGVyLl9jcmVhdGVQZW5kaW5nUHJvbWlzZSgpO1xuXG4gICAgICAgIHRoaXMuX2Fzc2lnblRhc2tFdmVudEhhbmRsZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2lzU3BlY2lhbFN0cmVhbSAoc3RyZWFtOiBXcml0YWJsZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKHN0cmVhbSBhcyBXcml0ZVN0cmVhbSkuaXNUVFkgfHwgc3RyZWFtID09PSBwcm9jZXNzLnN0ZG91dCB8fCBzdHJlYW0gPT09IHByb2Nlc3Muc3RkZXJyO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9jcmVhdGVQZW5kaW5nUHJvbWlzZSAoKTogUGVuZGluZ1Byb21pc2Uge1xuICAgICAgICBsZXQgcmVzb2x2ZXIgPSBudWxsO1xuXG4gICAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIHJlc29sdmVyID0gcmVzb2x2ZTtcbiAgICAgICAgfSkgYXMgdW5rbm93biBhcyBQZW5kaW5nUHJvbWlzZTtcblxuICAgICAgICBwcm9taXNlLnJlc29sdmUgPSByZXNvbHZlcjtcblxuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfY3JlYXRlUmVwb3J0SXRlbSAodGVzdDogVGVzdCwgcnVuc1BlclRlc3Q6IG51bWJlcik6IFJlcG9ydEl0ZW0ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZml4dHVyZTogICAgICAgICAgICAgICAgICAgIHRlc3QuZml4dHVyZSxcbiAgICAgICAgICAgIHRlc3Q6ICAgICAgICAgICAgICAgICAgICAgICB0ZXN0LFxuICAgICAgICAgICAgdGVzdFJ1bklkczogICAgICAgICAgICAgICAgIFtdLFxuICAgICAgICAgICAgc2NyZWVuc2hvdFBhdGg6ICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90czogICAgICAgICAgICAgICAgW10sXG4gICAgICAgICAgICB2aWRlb3M6ICAgICAgICAgICAgICAgICAgICAgW10sXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGVycnM6ICAgICAgICAgICAgICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHdhcm5pbmdzOiAgICAgICAgICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHVuc3RhYmxlOiAgICAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIHN0YXJ0VGltZTogICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgdGVzdFJ1bkluZm86ICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBwZW5kaW5nUnVuczogICAgICAgICAgICAgICAgcnVuc1BlclRlc3QsXG4gICAgICAgICAgICBwZW5kaW5nU3RhcnRzOiAgICAgICAgICAgICAgcnVuc1BlclRlc3QsXG4gICAgICAgICAgICBwZW5kaW5nVGVzdFJ1bkRvbmVQcm9taXNlOiAgUmVwb3J0ZXIuX2NyZWF0ZVBlbmRpbmdQcm9taXNlKCksXG4gICAgICAgICAgICBwZW5kaW5nVGVzdFJ1blN0YXJ0UHJvbWlzZTogUmVwb3J0ZXIuX2NyZWF0ZVBlbmRpbmdQcm9taXNlKCksXG4gICAgICAgICAgICBicm93c2VyczogICAgICAgICAgICAgICAgICAgW11cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfY3JlYXRlUmVwb3J0UXVldWUgKHRhc2s6IFRhc2spOiBSZXBvcnRJdGVtW10ge1xuICAgICAgICBjb25zdCBydW5zUGVyVGVzdCA9IHRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB0YXNrLnRlc3RzLm1hcCh0ZXN0ID0+IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRJdGVtKHRlc3QsIHJ1bnNQZXJUZXN0KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2NyZWF0ZVRlc3RSdW5JbmZvIChyZXBvcnRJdGVtOiBSZXBvcnRJdGVtKTogVGVzdFJ1bkluZm8ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZXJyczogICAgICAgICAgIHNvcnRCeShyZXBvcnRJdGVtLmVycnMsIFsndXNlckFnZW50JywgJ2NvZGUnXSksXG4gICAgICAgICAgICB3YXJuaW5nczogICAgICAgcmVwb3J0SXRlbS53YXJuaW5ncyxcbiAgICAgICAgICAgIGR1cmF0aW9uTXM6ICAgICArbmV3IERhdGUoKSAtIChyZXBvcnRJdGVtLnN0YXJ0VGltZSBhcyBudW1iZXIpLCAvL2VzbGludC1kaXNhYmxlLWxpbmUgIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHRyYS1wYXJlbnNcbiAgICAgICAgICAgIHVuc3RhYmxlOiAgICAgICByZXBvcnRJdGVtLnVuc3RhYmxlLFxuICAgICAgICAgICAgc2NyZWVuc2hvdFBhdGg6IHJlcG9ydEl0ZW0uc2NyZWVuc2hvdFBhdGggYXMgc3RyaW5nLFxuICAgICAgICAgICAgc2NyZWVuc2hvdHM6ICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdHMsXG4gICAgICAgICAgICB2aWRlb3M6ICAgICAgICAgcmVwb3J0SXRlbS52aWRlb3MsXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgcmVwb3J0SXRlbS5xdWFyYW50aW5lLFxuICAgICAgICAgICAgc2tpcHBlZDogICAgICAgIHJlcG9ydEl0ZW0udGVzdC5za2lwLFxuICAgICAgICAgICAgYnJvd3NlcnM6ICAgICAgIHJlcG9ydEl0ZW0uYnJvd3NlcnMsXG4gICAgICAgICAgICB0ZXN0SWQ6ICAgICAgICAgcmVwb3J0SXRlbS50ZXN0LmlkXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4gKHRlc3RSdW46IFRlc3RSdW4pOiBSZXBvcnRJdGVtIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIGZpbmQodGhpcy5yZXBvcnRRdWV1ZSwgaSA9PiBpLnRlc3QgPT09IHRlc3RSdW4udGVzdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfc2hpZnRSZXBvcnRRdWV1ZSAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCBjdXJyZW50Rml4dHVyZSA9IG51bGw7XG4gICAgICAgIGxldCBuZXh0UmVwb3J0SXRlbSA9IG51bGw7XG4gICAgICAgIGxldCByZXBvcnRJdGVtICAgICA9IG51bGw7XG5cbiAgICAgICAgd2hpbGUgKHRoaXMucmVwb3J0UXVldWUubGVuZ3RoICYmIHRoaXMucmVwb3J0UXVldWVbMF0udGVzdFJ1bkluZm8pIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0gICAgID0gdGhpcy5yZXBvcnRRdWV1ZS5zaGlmdCgpIGFzIFJlcG9ydEl0ZW07XG4gICAgICAgICAgICBjdXJyZW50Rml4dHVyZSA9IHJlcG9ydEl0ZW0uZml4dHVyZTtcblxuICAgICAgICAgICAgLy8gTk9URTogaGVyZSB3ZSBhc3N1bWUgdGhhdCB0ZXN0cyBhcmUgc29ydGVkIGJ5IGZpeHR1cmUuXG4gICAgICAgICAgICAvLyBUaGVyZWZvcmUsIGlmIHRoZSBuZXh0IHJlcG9ydCBpdGVtIGhhcyBhIGRpZmZlcmVudFxuICAgICAgICAgICAgLy8gZml4dHVyZSwgd2UgY2FuIHJlcG9ydCB0aGlzIGZpeHR1cmUgc3RhcnQuXG4gICAgICAgICAgICBuZXh0UmVwb3J0SXRlbSA9IHRoaXMucmVwb3J0UXVldWVbMF07XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hUb1BsdWdpbih7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRUZXN0RG9uZSxcbiAgICAgICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0Lm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdFJ1bkluZm8sXG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdC5tZXRhXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghbmV4dFJlcG9ydEl0ZW0pXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIGlmIChuZXh0UmVwb3J0SXRlbS5maXh0dXJlID09PSBjdXJyZW50Rml4dHVyZSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFJlcG9ydGVyUGx1Z2luTWV0aG9kLnJlcG9ydEZpeHR1cmVTdGFydCxcbiAgICAgICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICAgICAgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBuZXh0UmVwb3J0SXRlbS5maXh0dXJlLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgIG5leHRSZXBvcnRJdGVtLmZpeHR1cmUubWV0YVxuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfcmVzb2x2ZVJlcG9ydEl0ZW0gKHJlcG9ydEl0ZW06IFJlcG9ydEl0ZW0sIHRlc3RSdW46IFRlc3RSdW4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMudGFzay5zY3JlZW5zaG90cy5oYXNDYXB0dXJlZEZvcih0ZXN0UnVuLnRlc3QpKSB7XG4gICAgICAgICAgICByZXBvcnRJdGVtLnNjcmVlbnNob3RQYXRoID0gdGhpcy50YXNrLnNjcmVlbnNob3RzLmdldFBhdGhGb3IodGVzdFJ1bi50ZXN0KTtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdHMgICAgPSB0aGlzLnRhc2suc2NyZWVuc2hvdHMuZ2V0U2NyZWVuc2hvdHNJbmZvKHRlc3RSdW4udGVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy50YXNrLnZpZGVvcylcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0udmlkZW9zID0gdGhpcy50YXNrLnZpZGVvcy5nZXRUZXN0VmlkZW9zKHJlcG9ydEl0ZW0udGVzdC5pZCk7XG5cbiAgICAgICAgaWYgKHRlc3RSdW4ucXVhcmFudGluZSkge1xuICAgICAgICAgICAgcmVwb3J0SXRlbS5xdWFyYW50aW5lID0gdGVzdFJ1bi5xdWFyYW50aW5lLmF0dGVtcHRzLnJlZHVjZSgocmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBvYmplY3Q+LCBlcnJvcnM6IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlcltdLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFzc2VkICAgICAgICAgICAgPSAhZXJyb3JzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBxdWFyYW50aW5lQXR0ZW1wdCA9IGluZGV4ICsgMTtcblxuICAgICAgICAgICAgICAgIHJlc3VsdFtxdWFyYW50aW5lQXR0ZW1wdF0gPSB7IHBhc3NlZCB9O1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0sIHt9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcmVwb3J0SXRlbS50ZXN0UnVuSW5mbykge1xuICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0UnVuSW5mbyA9IFJlcG9ydGVyLl9jcmVhdGVUZXN0UnVuSW5mbyhyZXBvcnRJdGVtKTtcblxuICAgICAgICAgICAgaWYgKHJlcG9ydEl0ZW0udGVzdC5za2lwKVxuICAgICAgICAgICAgICAgIHRoaXMuc2tpcHBlZCsrO1xuICAgICAgICAgICAgZWxzZSBpZiAocmVwb3J0SXRlbS5lcnJzLmxlbmd0aClcbiAgICAgICAgICAgICAgICB0aGlzLmZhaWxlZCsrO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHRoaXMucGFzc2VkKys7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLl9zaGlmdFJlcG9ydFF1ZXVlKCk7XG5cbiAgICAgICAgKHJlcG9ydEl0ZW0ucGVuZGluZ1Rlc3RSdW5Eb25lUHJvbWlzZS5yZXNvbHZlIGFzIEZ1bmN0aW9uKSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ByZXBhcmVSZXBvcnRUZXN0QWN0aW9uRXZlbnRBcmdzICh7IGNvbW1hbmQsIGR1cmF0aW9uLCByZXN1bHQsIHRlc3RSdW4sIGVyciB9OiBSZXBvcnRUZXN0QWN0aW9uRXZlbnRBcmd1bWVudHMpOiBhbnkge1xuICAgICAgICBjb25zdCBhcmdzOiBhbnkgPSB7fTtcblxuICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgYXJncy5lcnIgPSBlcnI7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gJ251bWJlcicpXG4gICAgICAgICAgICBhcmdzLmR1cmF0aW9uID0gZHVyYXRpb247XG5cbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYXJncywge1xuICAgICAgICAgICAgdGVzdFJ1bklkOiB0ZXN0UnVuLmlkLFxuICAgICAgICAgICAgdGVzdDogICAgICB7XG4gICAgICAgICAgICAgICAgaWQ6ICAgIHRlc3RSdW4udGVzdC5pZCxcbiAgICAgICAgICAgICAgICBuYW1lOiAgdGVzdFJ1bi50ZXN0Lm5hbWUsXG4gICAgICAgICAgICAgICAgcGhhc2U6IHRlc3RSdW4ucGhhc2UsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZml4dHVyZToge1xuICAgICAgICAgICAgICAgIG5hbWU6IHRlc3RSdW4udGVzdC5maXh0dXJlLm5hbWUsXG4gICAgICAgICAgICAgICAgaWQ6ICAgdGVzdFJ1bi50ZXN0LmZpeHR1cmUuaWRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb21tYW5kOiBmb3JtYXRDb21tYW5kKGNvbW1hbmQsIHJlc3VsdCksXG4gICAgICAgICAgICBicm93c2VyOiB0ZXN0UnVuLmNvbnRyb2xsZXIuYnJvd3NlcixcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGRpc3BhdGNoVG9QbHVnaW4gKHsgbWV0aG9kLCBhcmdzID0gW10gfTogUGx1Z2luTWV0aG9kQXJndW1lbnRzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpblttZXRob2RdKC4uLmFyZ3MpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChvcmlnaW5hbEVycm9yKSB7XG4gICAgICAgICAgICBjb25zdCB1bmNhdWdodEVycm9yID0gbmV3IFJlcG9ydGVyUGx1Z2luRXJyb3Ioe1xuICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMucGx1Z2luLm5hbWUsXG4gICAgICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3JcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLnRhc2suZW1pdCgnZXJyb3InLCB1bmNhdWdodEVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX29uY2VUYXNrU3RhcnRIYW5kbGVyICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lICA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGNvbnN0IHVzZXJBZ2VudHMgPSB0aGlzLnRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubWFwKGdyb3VwID0+IGdyb3VwWzBdLnVzZXJBZ2VudCk7XG4gICAgICAgIGNvbnN0IGZpcnN0ICAgICAgPSB0aGlzLnJlcG9ydFF1ZXVlWzBdO1xuXG4gICAgICAgIGNvbnN0IHRhc2tQcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgY29uZmlndXJhdGlvbjogdGhpcy50YXNrLm9wdHNcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoVG9QbHVnaW4oe1xuICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRUYXNrU3RhcnQsXG4gICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgICAgICAgdXNlckFnZW50cyxcbiAgICAgICAgICAgICAgICB0aGlzLnRlc3RDb3VudCxcbiAgICAgICAgICAgICAgICB0aGlzLnRhc2sudGVzdFN0cnVjdHVyZSxcbiAgICAgICAgICAgICAgICB0YXNrUHJvcGVydGllc1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoVG9QbHVnaW4oe1xuICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRGaXh0dXJlU3RhcnQsXG4gICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICBmaXJzdC5maXh0dXJlLm5hbWUsXG4gICAgICAgICAgICAgICAgZmlyc3QuZml4dHVyZS5wYXRoLFxuICAgICAgICAgICAgICAgIGZpcnN0LmZpeHR1cmUubWV0YVxuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblRhc2tUZXN0UnVuU3RhcnRIYW5kbGVyICh0ZXN0UnVuOiBUZXN0UnVuKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnN0IHJlcG9ydEl0ZW0gPSB0aGlzLl9nZXRSZXBvcnRJdGVtRm9yVGVzdFJ1bih0ZXN0UnVuKSBhcyBSZXBvcnRJdGVtO1xuXG4gICAgICAgIHJlcG9ydEl0ZW0udGVzdFJ1bklkcy5wdXNoKHRlc3RSdW4uaWQpO1xuXG4gICAgICAgIGlmICghcmVwb3J0SXRlbS5zdGFydFRpbWUpXG4gICAgICAgICAgICByZXBvcnRJdGVtLnN0YXJ0VGltZSA9ICtuZXcgRGF0ZSgpO1xuXG4gICAgICAgIHJlcG9ydEl0ZW0ucGVuZGluZ1N0YXJ0cy0tO1xuXG4gICAgICAgIGlmICghcmVwb3J0SXRlbS5wZW5kaW5nU3RhcnRzKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBpZiAodGhpcy5wbHVnaW4ucmVwb3J0VGVzdFN0YXJ0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGVzdFN0YXJ0SW5mbyA9IHsgdGVzdFJ1bklkczogcmVwb3J0SXRlbS50ZXN0UnVuSWRzLCB0ZXN0SWQ6IHJlcG9ydEl0ZW0udGVzdC5pZCB9O1xuXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRUZXN0U3RhcnQgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICBhcmdzOiAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0udGVzdC5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0Lm1ldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXN0U3RhcnRJbmZvXG4gICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgKHJlcG9ydEl0ZW0ucGVuZGluZ1Rlc3RSdW5TdGFydFByb21pc2UucmVzb2x2ZSBhcyBGdW5jdGlvbikoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXBvcnRJdGVtLnBlbmRpbmdUZXN0UnVuU3RhcnRQcm9taXNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX29uVGFza1Rlc3RSdW5Eb25lSGFuZGxlciAodGVzdFJ1bjogVGVzdFJ1bik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCByZXBvcnRJdGVtICAgICAgICAgICAgICAgICAgICA9IHRoaXMuX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuKHRlc3RSdW4pIGFzIFJlcG9ydEl0ZW07XG4gICAgICAgIGNvbnN0IGlzVGVzdFJ1blN0b3BwZWRUYXNrRXhlY3V0aW9uID0gISF0ZXN0UnVuLmVycnMubGVuZ3RoICYmIHRoaXMuc3RvcE9uRmlyc3RGYWlsO1xuXG4gICAgICAgIHJlcG9ydEl0ZW0ucGVuZGluZ1J1bnMgPSBpc1Rlc3RSdW5TdG9wcGVkVGFza0V4ZWN1dGlvbiA/IDAgOiByZXBvcnRJdGVtLnBlbmRpbmdSdW5zIC0gMTtcbiAgICAgICAgcmVwb3J0SXRlbS51bnN0YWJsZSAgICA9IHJlcG9ydEl0ZW0udW5zdGFibGUgfHwgdGVzdFJ1bi51bnN0YWJsZTtcbiAgICAgICAgcmVwb3J0SXRlbS5lcnJzICAgICAgICA9IHJlcG9ydEl0ZW0uZXJycy5jb25jYXQodGVzdFJ1bi5lcnJzKTtcbiAgICAgICAgcmVwb3J0SXRlbS53YXJuaW5ncyAgICA9IHRlc3RSdW4ud2FybmluZ0xvZyA/IHVuaW9uKHJlcG9ydEl0ZW0ud2FybmluZ3MsIHRlc3RSdW4ud2FybmluZ0xvZy5tZXNzYWdlcykgOiBbXTtcblxuICAgICAgICByZXBvcnRJdGVtLmJyb3dzZXJzLnB1c2goT2JqZWN0LmFzc2lnbih7IHRlc3RSdW5JZDogdGVzdFJ1bi5pZCB9LCBnZXRCcm93c2VyKHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24pKSk7XG5cbiAgICAgICAgaWYgKCFyZXBvcnRJdGVtLnBlbmRpbmdSdW5zKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fcmVzb2x2ZVJlcG9ydEl0ZW0ocmVwb3J0SXRlbSwgdGVzdFJ1bik7XG5cbiAgICAgICAgYXdhaXQgcmVwb3J0SXRlbS5wZW5kaW5nVGVzdFJ1bkRvbmVQcm9taXNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX29uVGFza1Rlc3RBY3Rpb25TdGFydCAoeyBhcGlBY3Rpb25OYW1lLCAuLi5yZXN0QXJncyB9OiBSZXBvcnRUYXNrQWN0aW9uRXZlbnRBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAodGhpcy5wbHVnaW4ucmVwb3J0VGVzdEFjdGlvblN0YXJ0KSB7XG4gICAgICAgICAgICByZXN0QXJncyA9IHRoaXMuX3ByZXBhcmVSZXBvcnRUZXN0QWN0aW9uRXZlbnRBcmdzKHJlc3RBcmdzIGFzIHVua25vd24gYXMgUmVwb3J0VGVzdEFjdGlvbkV2ZW50QXJndW1lbnRzKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaFRvUGx1Z2luKHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFJlcG9ydGVyUGx1Z2luTWV0aG9kLnJlcG9ydFRlc3RBY3Rpb25TdGFydCBhcyBzdHJpbmcsXG4gICAgICAgICAgICAgICAgYXJnczogICBbXG4gICAgICAgICAgICAgICAgICAgIGFwaUFjdGlvbk5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHJlc3RBcmdzXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9vblRhc2tUZXN0QWN0aW9uRG9uZSAoeyBhcGlBY3Rpb25OYW1lLCAuLi5yZXN0QXJncyB9OiBSZXBvcnRUYXNrQWN0aW9uRXZlbnRBcmd1bWVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAodGhpcy5wbHVnaW4ucmVwb3J0VGVzdEFjdGlvbkRvbmUpIHtcbiAgICAgICAgICAgIHJlc3RBcmdzID0gdGhpcy5fcHJlcGFyZVJlcG9ydFRlc3RBY3Rpb25FdmVudEFyZ3MocmVzdEFyZ3MgYXMgdW5rbm93biBhcyBSZXBvcnRUZXN0QWN0aW9uRXZlbnRBcmd1bWVudHMpO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoVG9QbHVnaW4oe1xuICAgICAgICAgICAgICAgIG1ldGhvZDogUmVwb3J0ZXJQbHVnaW5NZXRob2QucmVwb3J0VGVzdEFjdGlvbkRvbmUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgIGFyZ3M6ICAgW1xuICAgICAgICAgICAgICAgICAgICBhcGlBY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgICAgICByZXN0QXJnc1xuICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfb25jZVRhc2tEb25lSGFuZGxlciAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGVuZFRpbWUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgICAgIHBhc3NlZENvdW50OiAgdGhpcy5wYXNzZWQsXG4gICAgICAgICAgICBmYWlsZWRDb3VudDogIHRoaXMuZmFpbGVkLFxuICAgICAgICAgICAgc2tpcHBlZENvdW50OiB0aGlzLnNraXBwZWRcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoVG9QbHVnaW4oe1xuICAgICAgICAgICAgbWV0aG9kOiBSZXBvcnRlclBsdWdpbk1ldGhvZC5yZXBvcnRUYXNrRG9uZSxcbiAgICAgICAgICAgIGFyZ3M6ICAgW1xuICAgICAgICAgICAgICAgIGVuZFRpbWUsXG4gICAgICAgICAgICAgICAgdGhpcy5wYXNzZWQsXG4gICAgICAgICAgICAgICAgdGhpcy50YXNrLndhcm5pbmdMb2cubWVzc2FnZXMsXG4gICAgICAgICAgICAgICAgcmVzdWx0XG4gICAgICAgICAgICBdXG4gICAgICAgIH0pO1xuXG4gICAgICAgICh0aGlzLnBlbmRpbmdUYXNrRG9uZVByb21pc2UucmVzb2x2ZSBhcyBGdW5jdGlvbikoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hc3NpZ25UYXNrRXZlbnRIYW5kbGVycyAoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHRhc2sgPSB0aGlzLnRhc2s7XG5cbiAgICAgICAgdGFzay5vbmNlKCdzdGFydCcsIGFzeW5jICgpID0+IGF3YWl0IHRoaXMuX29uY2VUYXNrU3RhcnRIYW5kbGVyKCkpO1xuXG4gICAgICAgIHRhc2sub24oJ3Rlc3QtcnVuLXN0YXJ0JywgYXN5bmMgdGVzdFJ1biA9PiBhd2FpdCB0aGlzLl9vblRhc2tUZXN0UnVuU3RhcnRIYW5kbGVyKHRlc3RSdW4pKTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LXJ1bi1kb25lJywgYXN5bmMgdGVzdFJ1biA9PiBhd2FpdCB0aGlzLl9vblRhc2tUZXN0UnVuRG9uZUhhbmRsZXIodGVzdFJ1bikpO1xuXG4gICAgICAgIHRhc2sub24oJ3Rlc3QtYWN0aW9uLXN0YXJ0JywgYXN5bmMgZSA9PiBhd2FpdCB0aGlzLl9vblRhc2tUZXN0QWN0aW9uU3RhcnQoZSkpO1xuXG4gICAgICAgIHRhc2sub24oJ3Rlc3QtYWN0aW9uLWRvbmUnLCBhc3luYyBlID0+IGF3YWl0IHRoaXMuX29uVGFza1Rlc3RBY3Rpb25Eb25lKGUpKTtcblxuICAgICAgICB0YXNrLm9uY2UoJ2RvbmUnLCBhc3luYyAoKSA9PiBhd2FpdCB0aGlzLl9vbmNlVGFza0RvbmVIYW5kbGVyKCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBkaXNwb3NlICgpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgaWYgKHRoaXMuZGlzcG9zZWQpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5kaXNwb3NlZCA9IHRydWU7XG5cbiAgICAgICAgaWYgKCF0aGlzLm91dFN0cmVhbSB8fCBSZXBvcnRlci5faXNTcGVjaWFsU3RyZWFtKHRoaXMub3V0U3RyZWFtKSB8fCAhaXNXcml0YWJsZVN0cmVhbSh0aGlzLm91dFN0cmVhbSkpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgY29uc3Qgc3RyZWFtRmluaXNoZWRQcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0aGlzLm91dFN0cmVhbS5vbmNlKCdmaW5pc2gnLCByZXNvbHZlKTtcbiAgICAgICAgICAgIHRoaXMub3V0U3RyZWFtLm9uY2UoJ2Vycm9yJywgcmVzb2x2ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub3V0U3RyZWFtLmVuZCgpO1xuXG4gICAgICAgIHJldHVybiBzdHJlYW1GaW5pc2hlZFByb21pc2U7XG4gICAgfVxufVxuIl19